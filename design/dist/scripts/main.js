"use strict";var drawMap=function(e,t,a,n,r,o,u){var s=$(o),c=$(u),i=_.maxBy(n,function(e){return e.value}),d=getTotalCountInMap(e,n);c.html(numeral(d).format());var p=s.width()-a,l=s.height(),h=d3.geoCentroid(e),f=[p/2,l/2],t=t,m=d3.select(o).append("svg").attr("width",p).attr("height",l),j=d3.scaleSequential(d3.interpolateReds),v=d3.geoMercator().scale(t).center(h).precision(.1).translate(f),b=d3.geoPath().projection(v);m.append("g").selectAll("path").data(e.features).enter().append("path").attr("fill",function(e){var t=0;return n.map(function(a){a.key==e.properties.NTACode&&(t=a.value/i.value)}),0==t?"white":j(t)}).attr("d",b).attr("stroke","grey").attr("stroke-width",.5).attr("class",function(e){return e.id}).append("title").text(function(e){var t=0,a=_.split(_.replace(_.replace(e.properties.NTAName,/etc-/,""),/-/g,"/"),"/");return n.map(function(a){a.key==e.properties.NTACode&&(t=a.value)}),a=a.map(function(e){return _.capitalize(e)}),_.join(a,"/")+": "+numeral(t).format()})},drawBar=function(e,t){var a=d3.select(t).append("svg").attr("width",315).attr("height",150).style("vertical-align","top"),n=d3.scaleBand().padding(.1).range([0,150]).domain(e.map(function(e){return e.name})),r=d3.scaleLinear().range([0,115]).domain([0,d3.max(e,function(e){return e.value})]),o=a.selectAll(".bar").data(e).enter().append("g").attr("transform",function(e){return"translate(-100,"+n(e.name)+")"}).attr("class","bar");o.append("rect").attr("x",200).attr("y",0).attr("width",function(e){return r(e.value)}).classed("highlight",function(e){return"Jan 2015"==e.name}).attr("height",n.bandwidth()),o.append("text").attr("x",196).attr("y",12).style("text-anchor","end").text(function(e){return e.name})},dataViz=function(e,t,a,n,r,o,u,s,c,i,d,p,l,h,f,m,j){if(e)throw e;var v=countValues(_.union(r,o,u,s,c,i),"value"),b=countValues(_.union(d,p,l,h,f,m),"value"),y=countValues(_.union(v,b),"value"),g=[r,o,u,s,c,i],w=[{key:0,value:"Jan 2015"},{key:1,value:"Feb 2015"},{key:2,value:"Mar 2015"},{key:3,value:"Apr 2015"},{key:4,value:"May 2015"},{key:5,value:"Jun 2015"}];_.each(g,function(e,t){var a={name:w[t].value,value:_.sumBy(e,"value")};g[t]=a}),drawMap(t,75e3,0,v,y,"#nyc-uber",".totalNYCUberPickups"),drawMap(t,75e3,315,v,y,"#nyc-uber-bar",".totalNYCUberPickups"),drawBar(g,"#nyc-uber-bar"),t={type:"FeatureCollection",features:_.filter(t.features,function(e){return"Manhattan"===e.properties.BoroName})},drawMap(t,15e4,0,v,y,"#manhattan-uber","#totalMNUberPickups"),drawMap(t,15e4,0,b,y,"#manhattan-fhv","#totalMNFHVPickups")},processFHVData=function(e){return e=e.map(function(e){var t="";return zones.map(function(a){a.location_id===e.locationID&&264!=a.location_id&&265!=a.location_id&&(t=a.ntacode)}),e.ntacode=t,e}),e=e.filter(function(e){if(""!=e.locationID&&""!=e.ntacode)return e})},processUberData=function(e,t){var a=[{key:0,value:"January 2015"},{key:1,value:"February 2015"},{key:2,value:"March 2015"},{key:3,value:"April 2015"},{key:4,value:"May 2015"},{key:5,value:"June 2015"}],n=a[t];return e=_.orderBy(_.filter(e,function(e){return moment(new Date(e.Pickup_date)).month()===n.key}),["Pickup_date"],["asc"]),_.each(e,function(e){return _.each(e,function(t,a){return e[a]=t.trim()})}),e=e.map(function(e){var t="";return zones.map(function(a){a.location_id===e.locationID&&(t=a.ntacode)}),e.ntacode=t,e}),_.orderBy(_.map(_.countBy(e,"ntacode"),function(e,t){return{key:t,value:e}}),"value","desc")},getTotalCountInMap=function(e,t){var a=0;return _.each(e.features,function(e){_.each(t,function(t){t.key==e.properties.NTACode&&(a+=t.value)})}),a},countValues=function(e){var t=_(e).groupBy("key").map(function(e,t){return{key:t,value:_.sumBy(e,"value")}}).value();return _.orderBy(t,"value","desc")};d3.queue().defer(d3.json,"https://raw.githubusercontent.com/se2/cis602-02-project/master/design/nyc.geo.2.json").defer(d3.csv,"https://media.githubusercontent.com/media/se2/cis602-02-project/master/data/fhv_bases.csv").defer(d3.csv,"https://media.githubusercontent.com/media/se2/cis602-02-project/master/data/taxi-zone-lookup-with-ntacode.csv").defer(d3.json,"https://raw.githubusercontent.com/se2/cis602-02-project/master/data/uber/uber-jan-june15/jan.json").defer(d3.json,"https://raw.githubusercontent.com/se2/cis602-02-project/master/data/uber/uber-jan-june15/feb.json").defer(d3.json,"https://raw.githubusercontent.com/se2/cis602-02-project/master/data/uber/uber-jan-june15/mar.json").defer(d3.json,"https://raw.githubusercontent.com/se2/cis602-02-project/master/data/uber/uber-jan-june15/apr.json").defer(d3.json,"https://raw.githubusercontent.com/se2/cis602-02-project/master/data/uber/uber-jan-june15/may.json").defer(d3.json,"https://raw.githubusercontent.com/se2/cis602-02-project/master/data/uber/uber-jan-june15/jun.json").defer(d3.json,"https://raw.githubusercontent.com/se2/cis602-02-project/master/data/fhv/jan.jun.15/fhv_2015-01.json").defer(d3.json,"https://raw.githubusercontent.com/se2/cis602-02-project/master/data/fhv/jan.jun.15/fhv_2015-02.json").defer(d3.json,"https://raw.githubusercontent.com/se2/cis602-02-project/master/data/fhv/jan.jun.15/fhv_2015-03.json").defer(d3.json,"https://raw.githubusercontent.com/se2/cis602-02-project/master/data/fhv/jan.jun.15/fhv_2015-04.json").defer(d3.json,"https://raw.githubusercontent.com/se2/cis602-02-project/master/data/fhv/jan.jun.15/fhv_2015-05.json").defer(d3.json,"https://raw.githubusercontent.com/se2/cis602-02-project/master/data/fhv/jan.jun.15/fhv_2015-06.json").defer(d3.json,"https://raw.githubusercontent.com/minhnaru/cis602-02-project/master/data/natality.json").await(dataViz);